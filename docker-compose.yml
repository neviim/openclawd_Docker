services:
  # Serviço principal Openclawd
  openclawd:
    build:
      context: ./openclawd
      dockerfile: Dockerfile
    container_name: openclawd-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - MONITOR_ENABLED=true
      - ACTIVITY_LOG_PATH=/logs/activity.log
    volumes:
      - ./data/openclawd:/app/data
      - ./logs:/logs
      - ./config/openclawd:/app/config:ro
    networks:
      - openclawd-network
    ports:
      - "3000:3000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp
      - /app/tmp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.lifecycle.pre-update=./scripts/pre-update.sh"
      - "com.centurylinklabs.watchtower.lifecycle.post-update=./scripts/post-update.sh"

  # Sistema Kanban de Monitoramento
  kanban-monitor:
    build:
      context: ./kanban-monitor
      dockerfile: Dockerfile
    container_name: kanban-monitor
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - OPENCLAWD_HOST=openclawd
      - OPENCLAWD_PORT=3000
      - MONITOR_INTERVAL=5000
      - DB_PATH=/data/kanban.db
    volumes:
      - ./data/kanban:/data
      - ./logs:/logs:ro
      - ./config/kanban:/app/config:ro
    networks:
      - openclawd-network
    ports:
      - "8080:8080"
    depends_on:
      openclawd:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Coletor de Logs e Métricas
  log-collector:
    image: fluent/fluent-bit:3.2
    container_name: log-collector
    restart: unless-stopped
    volumes:
      - ./logs:/logs:ro
      - ./config/fluent-bit/fluent-bit.conf:/etc/fluent-bit/fluent-bit.conf:ro
    networks:
      - openclawd-network
    depends_on:
      - openclawd
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Banco de dados para histórico
  postgres:
    image: postgres:16-alpine
    container_name: openclawd-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=openclawd_monitor
      - POSTGRES_USER=openclawd
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - openclawd-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openclawd -d openclawd_monitor"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Redis para cache e filas
  redis:
    image: redis:7-alpine
    container_name: openclawd-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      - ./data/redis:/data
    networks:
      - openclawd-network
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  # Watchtower - Monitoramento de Atualizações
  watchtower:
    image: containrrr/watchtower:latest
    container_name: openclawd-watchtower
    restart: unless-stopped
    environment:
      - DOCKER_API_VERSION=1.44
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      - WATCHTOWER_DEBUG=false
      - WATCHTOWER_TRACE=false
      - WATCHTOWER_MONITOR_ONLY=${WATCHTOWER_MONITOR_ONLY:-false}
      - TZ=America/Sao_Paulo
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/watchtower:/config:ro
      - ./logs/watchtower:/logs
    networks:
      - openclawd-network
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    command: --schedule "0 0 2 * * *" --cleanup --debug

networks:
  openclawd-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

secrets:
  db_password:
    file: ./config/secrets/db_password.txt

volumes:
  openclawd-data:
  kanban-data:
  postgres-data:
  redis-data:
